<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Spartacus | 为自由而生</title>
    <meta name="keywords" content="H+后台主题,后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description" content="H+是一个完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">

    <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">
    
    <link href="plugins/clipboard/tether/css/tether.min.css" rel="stylesheet">
    <link href="plugins/clipboard/context-menu.css" rel="stylesheet">
    
    <link href="css/plugins/jsTree/style.min.css" rel="stylesheet">
    
    <link href="plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet">
    
    <link href="plugins/bootstrap-pagination-0.6.2/bootstrap-pagination.css" rel="stylesheet">

	<link rel="stylesheet" href="js/jqcloud/jqcloud.min.css">

	<link rel="stylesheet" href="plugins/bootoast/bootoast.css" type="text/css">
    
    <!--<link href="/picimage/style.css" type="text/css" rel="stylesheet">-->
    <!--<link href="/picimage/swiper.min.css" type="text/css" rel="stylesheet">-->
    
	<style>
        .jstree-open > .jstree-anchor > .fa-folder:before {
            content: "\f07c";
        }
        .jstree-default .jstree-icon .none {
            width: 0;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInUp">
        <div class="row">
        	<div class="col-sm-12">
        	<div class="ibox">
                <div class="ibox-title">
                    <h5 id="title_name">资源列表</h5>
                </div>
                <div class="ibox-content">
                    
                    <div class="row m-b-sm m-t-sm">
			            <div class="col-sm-3">
			                <div class="ibox float-e-margins">
			                    <div class="ibox-content" style="border-top-width: 0;">
			                        <div class="file-manager">
			                            <!--<h5>显示</h5>-->
			                            <div>
				                            <div style="width: 50%; float: left;">
												<font style="font-weight: 600; font-size: 12px;">递归&nbsp;:</font>
										 		<input id="recursive_switch" type="checkbox"/>
											</div>
											<div style="width: 50%; float: left;">
												<font style="font-weight: 600; font-size: 12px;">预览&nbsp;:</font>
										 		<input id="loading_switch" type="checkbox"/>
											</div>
										</div>
										<div class="clearfix" style="padding-bottom: 15px;"></div>
										
                                        <h5>目录树&nbsp;<a id="refresh_id"><i class="fa fa-spinner"></i></a></h5>
			                            <div id="jstree">
				                            <ul>
				                                <li class="jstree-open">image
				                                    <ul>
				                                        <li class="jstree-open">工作
				                                            <ul>
				                                                <li>public</li>
				                                                <li>private</li>
				                                            </ul>
				                                        </li>
				                                        <li class="jstree-open">旅游
				                                            <ul>
				                                                <li>public</li>
				                                                <li>private</li>
				                                            </ul>
				                                        </li>
				                                        <li class="jstree-open">生活
				                                            <ul>
				                                                <li>public</li>
				                                                <li>private</li>
				                                            </ul>
				                                        </li>
				                                        <li class="jstree-open">随拍
				                                            <ul>
				                                                <li>public</li>
				                                                <li>private</li>
				                                            </ul>
				                                        </li>
				                                        <li class="jstree-open">未分类
				                                            <ul>
				                                                <li>public</li>
				                                                <li>private</li>
				                                            </ul>
				                                        </li>
				                                    </ul>
				                                </li>
				                            </ul>
				                        </div>
			                            <div class="clearfix"></div>
			                            
			                            <div class="hr-line-dashed"></div>
			                            <h5>标签</h5>
										<div id="tag_cloud">
											<ul id="tag_list" class="tag-list" style="padding: 0">
												<!--<li><a href="file_manager.html">鼠标</a>
												</li>
												<li><a href="file_manager.html">g502</a>
												</li>
												<li><a href="file_manager.html">家庭</a>
												</li>
												<li><a href="file_manager.html">孩子</a>
												</li>
												<li><a href="file_manager.html">假期</a>
												</li>
												<li><a href="file_manager.html">音乐</a>
												</li>
												<li><a href="file_manager.html">照片</a>
												</li>
												<li><a href="file_manager.html">电影</a>
												</li>-->
											</ul>
										</div>
			                            <div class="clearfix"></div>
			                            
			                            <div class="hr-line-dashed"></div>
			                            <button type="button" class="btn btn-primary btn-block" onclick="webUploader();" >上传文件</button>
			                        </div>
			                    </div>
			                </div>
			            </div>
			            <div class="col-sm-9 animated fadeInRight">
					        <div class="row m-b-sm m-t-sm">
		                        <div id="botton_group_id" class="col-md-7" style="padding-left: 0;">
		                            <button type="button" id="all_none_select_id" class="btn btn-white btn-sm" onclick="selectAll();"><i class="fa fa-signing"></i>&nbsp;全选/全不选</button>
		                            <button type="button" id="batch_pass_id" class="btn btn-white btn-sm" onclick="batchDownload();"><i class="fa fa-cloud-download"></i>&nbsp;批量下载</button>
									<div class="btn-group">
										<button type="button" class="btn btn-white btn-sm dropdown-toggle" data-toggle="dropdown"><i class="fa fa-institution "></i>&nbsp;设置为
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu" role="menu">
											<li><a href="javascript:;" onclick="_batchSetObjectAcl(2);">共有读</a></li>
											<li><a href="javascript:;" onclick="_batchSetObjectAcl(1);">私有读</a></li>
										</ul>
									</div>
									<div class="btn-group">
										<button type="button" class="btn btn-white btn-sm dropdown-toggle" data-toggle="dropdown"><i class="fa fa-random"></i>&nbsp;移动到
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu" role="menu">
<!--											<li><a href="#">功能1</a></li>-->
											<li><div id="menu_tree_id"></div></li>
										</ul>
									</div>
									<button type="button" id="batch_trash_id" style="display: none" class="btn btn-white btn-sm" onclick="batch_delete();"><i class="fa fa-trash"></i>&nbsp;批量删除</button>
									<button type="button" id="batch_recycle_id" style="display: none" class="btn btn-white btn-sm" onclick="batch_recycle();"><i class="fa fa-truck"></i>&nbsp;移到回收站</button>
								</div>
		                        <div class="col-md-5">
									<div class="input-group pull-right">
		                                <input id="search_input_id" type="text" placeholder="请输入搜索内容..." class="input-sm form-control">
		                                <span class="input-group-btn">
		                                    <button id="search_button_id" class="btn btn-sm btn-primary">&nbsp;搜索</button>
		                                </span>
		                            </div>
		                        </div>
		                    </div>
			                <div class="row gray-bg">
			                    <div class="col-sm-12" id="file_container_id" style="padding-top: 10px;">
			                        <div class="file-box leftClick rightClick" style="position: relative;" onmousedown="setGlobalObject(this)" url="https://xxx/1.jpg">
			                            <div class="file">
			                                <div class="icon" align="center">
			                                    <i class="fa fa-image"></i>
			                                </div>
			                                <div class="file-name" align="center">
			                                    <!--Document_2014.doc
			                                    <br/>-->
			                                    <small style="align-content: center;">时间：2014-10-13</small>
			                                </div>
			                            </div>
			                            <span style="position:absolute; right:0; top:1%; margin-right: 20px;">
									  		<img style="position: relative; top: 0; right: 0; border: 0;" src="img/ribbon_public.png">
									  	</span>
									  	<span class="select" style="position:absolute; right:0; top:1%; margin-right: 20px; display: none;" url="https://xxx/1.jpg">
									  		<img style="position: relative; bottom: 10px; right: 0; border: 0;" src="img/select.png">
									  	</span>
			                        </div>
			                        
			                        <div class="file-box leftClick rightClick" style="position: relative;" onmousedown="setGlobalObject(this)" url="https://xxx/1.jpg">
			                            <div class="file">
			                                <div class="image" align="center" style="display:flex;justify-content:center;align-items:center;">
												<img alt="image" class="img-responsive" src="img/50.png">
			                                </div>
			                                <div class="file-name" align="center">
			                                    <!--Italy street.jpg
			                                    <br/>-->
			                                    <small style="align-content: center;">时间：2014-10-13</small>
			                                </div>
			                            </div>
			                            
			                            <span style="position:absolute; right:0; top:1%; margin-right: 20px;">
									  		<img style="position: relative; top: 0; right: 0; border: 0;" src="img/ribbon_private.png">
									  	</span>
									  	<span class="select" style="position:absolute; right:0; top:1%; margin-right: 20px; display: none;" url="https://xxx/1.jpg">
									  		<img style="position: relative; bottom: 10px; right: 0; border: 0;" src="img/select.png">
									  	</span>
			                        </div>
			                        
			                        
			                    </div>
			                    <!--分页-->
								<div class="text-center">
									<!-- 下面是控制分页控件，必须要是ul元素才行 -->
									<ul id='page_element_id1' class="pagination pagination-lg" style="margin: 0 0;"></ul>
									<ul id='page_element_id2' class="pagination pagination-lg" style="margin: 0 0;"></ul>
								</div>
			                </div>
			            </div>
            		</div>
            		
            	</div>
            </div>
        </div>
        </div>
    </div>

<!-- 全局js -->
<script src="js/jquery.min.js?v=2.1.4"></script>
<script src="js/bootstrap.min.js?v=3.3.6"></script>
<script src="js/content.js?v=1.0.0"></script>
<script src="js/layer/layer.js"></script>
<script src="plugins/clipboard/tether/js/tether.min.js"></script>
<script src="plugins/clipboard/jquery.context-menu.min.js"></script>
<script src="plugins/bootstrap-pagination-0.6.2/bootstrap-pagination.js"></script>

<!-- jsTree plugin javascript -->
<script src="js/plugins/jsTree/jstree.min.js"></script>
<script src="plugins/bootstrap-switch/js/bootstrap-switch.min.js"></script>
<script src="js/jqcloud/jqcloud.js"></script>
<script src="plugins/bootoast/bootoast.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script src="plugins/eventsource/eventsource.min.js" type="text/javascript"></script>
<script src="js/loadconfig.js"></script>
	<script type="text/javascript" src="wechat/js/sockjs.js"></script>
	<script type="text/javascript" src="wechat/js/stomp.umd.js"></script>

<script type="text/javascript">

	var base_domain = getConfig('base_domain');
	var jwt = JSON.parse(window.localStorage.getItem('spartacus-jwt') || '{}');

var global_currentPage = 1;
var global_pageSize = 15;

var global_object = null;

var global_root_dir_path = getUrlParam('global_root_dir_path') + "/";
var global_dir_path = global_root_dir_path;
var global_cos_type = 0;
var is_upload_success = false;

var select_all_flag = 'all';
var global_is_search = false;

var fileNumLimit = parseInt(getUrlParam('fileNumLimit'));
var fileSizeLimit = parseInt(getUrlParam('fileSizeLimit'));
var fileSingleSizeLimit = parseInt(getUrlParam('fileSingleSizeLimit'));

//分页按钮组是否存在
var isPaginatorExist1 = false;

var global_extensions = {
	".gif":"file-image-o",
	".jpg":"file-image-o",
	".jpeg":"file-image-o",
	".bmp":"file-image-o",
	".png":"file-image-o",
	".mp3":"file-audio-o",
	".aac":"file-audio-o",
	".wav":"file-audio-oic",
	".mp4":"file-video-o",
	".mpeg":"file-video-o",
	".avi":"file-video-o",
	".wmv":"file-video-o",
	".flv":"file-video-o",
	".rmvb":"file-video-o",
	".doc":"file-word-o",
	".docx":"file-word-o",
	".xls":"file-excel-o",
	".xlsx":"file-excel-o",
	".ppt":"file-powerpoint-o",
	".pptx":"file-powerpoint-o",
	".pdf":"file-pdf-o",
	".zip":"file-zip-o",
	".rar":"file-zip-o",
	".7z":"file-zip-o",
	".tar":"file-zip-o"
}

$(function() {

	//0、左侧栏开关按钮
	// 注意：初始化就用链式配置，且state属性的设置一定放在最后，不知道为什么，哈哈
	$('#recursive_switch').bootstrapSwitch('onText','ON').bootstrapSwitch('offText','OFF').bootstrapSwitch('size','mini').bootstrapSwitch('state',false);
	// 添加按钮切换事件
	$('#recursive_switch').bootstrapSwitch('onSwitchChange', function(event, state) {
    	if(state == true) {
    		console.log('on');
    	} else {
    		console.log('off');
    	}
    });
    
    // 注意：初始化就用链式配置，且state属性的设置一定放在最后，不知道为什么，哈哈
	$('#loading_switch').bootstrapSwitch('onText','ON').bootstrapSwitch('offText','OFF').bootstrapSwitch('size','mini').bootstrapSwitch('state',false);
	// 添加按钮切换事件
	$('#loading_switch').bootstrapSwitch('onSwitchChange', function(event, state) {
    	if(state == true) {
    		console.log('on');
    	} else {
    		console.log('off');
    	}
    });

	//单击搜索按钮
	$('#search_button_id').click(function () {
		submitSearch(global_cos_type, global_root_dir_path, 1, 15);
	});

	//批量删除、移到回收站按钮
	if(global_root_dir_path == 'recycle/') {
		$("#batch_trash_id").css("display", "");
		$("#batch_recycle_id").css("display", "none");
	} else {
		$("#batch_trash_id").css("display", "none");
		$("#batch_recycle_id").css("display", "");
	}

})

function selectAll() {
	// 获取所有的复选框
	var selElements=document.getElementsByClassName('select');
	if(select_all_flag == 'all') {
		for(var i=0;i<selElements.length;i++) {
			var sel=selElements[i];
			$(sel).css('display','block');
		}
		select_all_flag = 'none';
	} else if(select_all_flag == 'none') {
		for(var i=0;i<selElements.length;i++) {
			var sel=selElements[i];
			$(sel).css('display','none');
		}
		select_all_flag = 'all';
	}
}

// 右键图片显示菜单
function setGlobalObject(obj) {
	global_object = obj;
}

/**
 * 复制外链
 */
function copyOuterLink() {
	var input = document.createElement('input');
	document.body.appendChild(input);
 	input.setAttribute('value', $(global_object).attr('url'));
	input.select();
	if (document.execCommand('copy')) {
		parent.layer.msg('复制成功！', {
			icon: 1,
			time: 1000
		});
	} else {
		parent.layer.msg('复制失败！', {
			icon: 2,
			time: 1000
		});
	}
    document.body.removeChild(input);
}

function myBrowser() {
	var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
	if (userAgent.indexOf("OPR") > -1) {
		return "Opera";
	} //判断是否Opera浏览器 OPR/43.0.2442.991
	if (userAgent.indexOf("Firefox") > -1) {
		return "FF";
	} //判断是否Firefox浏览器  Firefox/51.0
	if (userAgent.indexOf("Trident") > -1) {
		return "IE";
	} //判断是否IE浏览器  Trident/7.0; rv:11.0
	if (userAgent.indexOf("Edge") > -1) {
		return "Edge";
	} //判断是否Edge浏览器  Edge/14.14393
	if (userAgent.indexOf("Chrome") > -1) {
		return "Chrome";
	} // Chrome/56.0.2924.87
	if (userAgent.indexOf("Safari") > -1) {
		return "Safari";
	} //判断是否Safari浏览器 AppleWebKit/534.57.2 Version/5.1.7 Safari/534.57.2
}

function convertBase64ToBlob(base64, contentType) {
	var bytes = window.atob(base64);
	var	n = bytes.length;
	var uint8Array = new Uint8Array(n);
	while(n--){
		uint8Array[n] = bytes.charCodeAt(n);
	}
	return new Blob([uint8Array], { type: contentType });
}

/**
 * 单文件下载
 */
function download() {
	//图片格式和PDF
	var key = $(global_object).attr('key');
	$.ajax({
		type: "POST",
		url: base_domain+"/spartacus-resource/cos/download",
		dataType: "json",
		async: true,
		data: {
			"key": key
		},
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function (res) {
			if (res.code == 0) {
				var base64 = res.data.base64;
				var contentType = res.data.contentType;
				var blob = convertBase64ToBlob(base64, contentType); // 转为blob对象
				var fileName = res.data.fileName;
				if (myBrowser() == "IE") {
					window.navigator.msSaveBlob(blob, fileName);
				} else if (myBrowser() == "FF") {
					window.location.href = url;
				} else {
					var a = document.createElement("a");
					a.download = fileName;
					a.href = window.URL.createObjectURL(blob);
					a.click();
				}

			} else {
				parent.layer.msg(res.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}

function batchDownload() {
	var keysStr = "";

	// 获取所有已选中
	var selElements=document.getElementsByClassName('select');
	$(selElements).each(function () {
		if($(this).css("display")=="block"){
			keysStr = keysStr + "," + $(this).attr("key");
		}
	});

	if(keysStr == null || keysStr == "") {
		parent.layer.msg('请先选择要下载的文件！', {
			icon: 2,
			time: 1000
		});
		return;
	}

	keysStr = keysStr.substring(1);
	$.ajax({
		type: "POST",
		url: base_domain+"/spartacus-resource/cos/batchDownload",
		dataType: "json",
		async: true,
		data: {
			"keysStr": keysStr
		},
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function (res) {
			if (res.code == 0) {
				var base64 = res.data.base64;
				var contentType = res.data.contentType;
				var blob = convertBase64ToBlob(base64, contentType); // 转为blob对象
				var fileName = res.data.fileName;
				if (myBrowser() == "IE") {
					window.navigator.msSaveBlob(blob, fileName);
				} else if (myBrowser() == "FF") {
					window.location.href = url;
				} else {
					var a = document.createElement("a");
					a.download = fileName;
					a.href = window.URL.createObjectURL(blob);
					a.click();
				}

			} else {
				parent.layer.msg(res.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}

function checkImage(fileName) {
	fileName = fileName.toLowerCase();
	if(fileName.endsWith('.gif') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.bmp') || fileName.endsWith('.png')) {
		return true;
	}
	return false;
}

/**
 * 图片预览
 */
function preview() {
	var key = $(global_object).attr('key');
	var url = $(global_object).attr('url');
	var fileName = $(global_object).attr('fileName');

	if(!checkImage(fileName)) {
		parent.layer.msg('非图片资源无法预览！', {
			icon: 2,
			time: 1000
		});
		return;
	}

	var config = {title: fileName, src: url};
	var img = new Image();
	img.onload = function() {//避免图片还未加载完成无法获取到图片的大小
		//避免图片太大，导致弹出展示超出了网页显示访问，所以图片大于浏览器时下窗口可视区域时，进行等比例缩小。
		var max_height = $(window).height() - 100;
		var max_width = $(window).width();
		//rate1，rate2，rate3 三个比例中取最小的。
		var rate1 = max_height/img.height;
		var rate2 = max_width/img.width;
		var rate3 = 1;
		var rate = Math.min(rate1,rate2,rate3);
		//等比例缩放
		config.height = img.height * rate; //获取图片高度
		config.width = img.width  * rate; //获取图片宽度

		var imgHtml = "<img id='preview_id' src='" + img.src + "' width='"+config.width+"px' height='"+config.height+"px'/>";
		layer.open({
			type: 1,
			shade: 0.4,
			offset: 'auto',
			area: [config.width + 'px',config.height + 42 +'px'], ////宽，高
			shadeClose:true,
			scrollbar: false,
			title: config.title, //不显示标题
			content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
			cancel: function () {
				//layer.msg('捕获就是从页面已经存在的元素上，包裹layer的结构', { time: 5000, icon: 6 });
			}
		});
	}
	img.onerror = function () {
		$.ajax({
			type: "POST",
			url: base_domain+"/spartacus-resource/cos/download",
			dataType: "json",
			async: true,
			data: {
				"key": key
			},
			headers: {
				"clientId":"spartacus-friday",
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success: function (result) {
				if (result.code == 0) {
					var base64 = result.data.base64;
					var contentType = result.data.contentType;
					img.src = "data:"+contentType+";base64," + base64;
				} else {
					parent.layer.msg(result.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});
	}
	img.src = config.src;
}


/**
 * 建立websocket连接
 *
 * @param notices 提示语，json格式
 * @param target_is_directory 操作对象是否是目录，true/false
 */
var stompClient = null;
var target_is_directory = false;
var notices = {};
function connect_to_wb_server() {
	var jwt = JSON.parse(window.localStorage.getItem('spartacus-jwt') || '{}');
	var accessToken = jwt.access_token;

	//先检查token是否有效，再创建连接
	if(checkToken(accessToken)==true) {
		stompClient = new StompJs.Client({
			connectHeaders: {
				Authorization:"bearer " + jwt.access_token//自定义请求头
			},
			debug: function (str) {
				console.log(str);
			},
			reconnectDelay: 3000,
			heartbeatIncoming: 4000,
			heartbeatOutgoing: 4000,
		});

		stompClient.webSocketFactory = function () {
			return new SockJS(base_domain+'/spartacus-resource/endpoint');
		};

		stompClient.onConnect = function (frame) {
			stompClient.subscribe('/topic/fileReadStatusChangeNotice', function (response) {
				console.log("收到提示信息：");
				var resp = JSON.parse(response.body);
				console.log(resp);

				//TODO
				if(resp.payload.code == 0) {
					bootoast({
						message: notices[resp.payload.code],
						type: 'success',
						position:'right-top',
						timeout:3
					});

					if(target_is_directory) {
						$('#jstree').jstree('refresh');
					} else {
						getPage(global_dir_path, global_currentPage, global_pageSize, null);
					}

				} else {
					bootoast({
						message: notices[resp.payload.code],
						type: 'danger',
						position:'right-top',
						timeout:3
					});
				}
				//TODO

				response.ack();
			}, {ack:'client'});
		};

		stompClient.onStompError = function (frame) {
			console.log('Broker reported error: ' + frame.headers['message']);
			console.log('Additional details: ' + frame.body);
		};

		stompClient.activate();

	} else {
		layer.msg('连接失败，请登录后再试试吧！', {
			time: 1800
		}, function(){
			parent.layer.close(parent.global_chat_window_iframe_index);
		});
	}
}

connect_to_wb_server();

//关闭/刷新页面、关闭浏览器时，断开链接
window.onbeforeunload = function(){
	if(stompClient != null && stompClient.connected) {
		stompClient.deactivate();
	}
}

//检查token是否有效
function checkToken(accessToken) {
	var valid = false;
	if(!$.isEmptyObject(accessToken)) {
		$.ajax({
			url: base_domain+"/spartacus-gateway/jwt/decode/"+accessToken,
			type: "GET",
			dataType: "json",
			async: false,
			headers: {
				"clientId":"spartacus-friday"
			},
			success: function (result) {
				console.log(result);
				if(result.code == 200) {
					valid = true;
				}
			}
		});
	}
	return valid;
}

/**
 * 重命名
 */
function rename() {
	var key = $(global_object).attr('key');
	var origin_name = $(global_object).attr('fileName');
	origin_name = origin_name.substring(0, origin_name.lastIndexOf('.'));
	var file_extension = key.substring(key.lastIndexOf('.'));
	layer.prompt({
		value: origin_name,
		title: '重命名'}, function(val, index){

		target_is_directory = false;
		notices = {0:'重命名成功！', 1:'重命名失败！', 2:'重命名失败！请手动修改mysql和es中该文件的名称！', 3:'重命名失败！请手动修改es中该文件的名称！'};

		$.ajax({
			type: "POST",
			url: base_domain+"/spartacus-resource/cos/rename",
			dataType: "json",
			async: true,
			data: {
				"key": key,
				"newFileName": val + file_extension
			},
			headers: {
				"clientId":"spartacus-friday",
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success: function (result) {
				if(result.code == 0) {
					parent.layer.msg('正在重命名，请稍后...', {
						icon: 1,
						time:1000
					});

				} else {
					parent.layer.msg(result.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});

		layer.close(index);
	});
}

/**
 * 单文件删除
 */
function _delete() {
	parent.layer.confirm('确定删除该文件吗？', {
		btn: ['确定','取消'] //按钮
	}, function() {
		target_is_directory = false;
		notices = {0:'删除成功！', 1:'删除失败！', 2:'删除失败！请确认mysql和es中是否已删除该文件！', 3:'删除失败！请确认es中是否已删除该文件！'};

		var key = $(global_object).attr('key');

		$.ajax({
			type: "POST",
			url: base_domain+"/spartacus-resource/cos/batchDelete",
			dataType: "json",
			async: true,
			data: {
				"keysStr": key
			},
			headers: {
				"clientId":"spartacus-friday",
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success: function (result) {
				if(result.code == 0) {
					parent.layer.msg('正在删除，请稍后...', {
						icon: 1,
						time: 1000
					});

				} else {
					parent.layer.msg(result.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});
	});
}

/**
 * 批量删除
 */
function batch_delete() {
	var keysStr = "";

	// 获取所有已选中
	var selElements = document.getElementsByClassName('select');
	$(selElements).each(function () {
		if ($(this).css("display") == "block") {
			keysStr = keysStr + "," + $(this).attr("key");
		}
	});

	if (keysStr == null || keysStr == "") {
		parent.layer.msg('请先选择要删除的文件！', {
			icon: 2,
			time: 1000
		});
		return;
	}

	keysStr = keysStr.substring(1);
	parent.layer.confirm('确定删除吗？', {
		btn: ['确定','取消'] //按钮
	}, function() {
		target_is_directory = false;
		notices = {0:'删除成功！', 1:'删除失败！', 2:'删除失败！请确认mysql和es中是否已删除该文件！', 3:'删除失败！请确认es中是否已删除该文件！'};

		$.ajax({
			type: "POST",
			url: base_domain+"/spartacus-resource/cos/batchDelete",
			dataType: "json",
			async: true,
			data: {
				"keysStr": keysStr
			},
			headers: {
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success: function (result) {
				if(result.code == 0) {
					parent.layer.msg('正在删除，请稍后...', {
						icon: 1,
						time:1000
					});

				} else {
					parent.layer.msg(result.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});
	});
}

/**
 * 移动到回收站
 */
function recycle() {
	var key = $(global_object).attr('key');
	batch_move(key, 'recycle/');
}

/**
 * 批量移动到回收站
 */
function batch_recycle() {
	var keysStr = "";

	// 获取所有已选中
	var selElements = document.getElementsByClassName('select');
	$(selElements).each(function () {
		if ($(this).css("display") == "block") {
			keysStr = keysStr + "," + $(this).attr("key");
		}
	});

	if (keysStr == null || keysStr == "") {
		parent.layer.msg('请先选择要移动的文件！', {
			icon: 2,
			time: 1000
		});
		return;
	}
	keysStr = keysStr.substring(1);
	batch_move(keysStr, 'recycle/');
}

/**
 *  批量移动
 */
function batch_move(keysStr, destDirPath) {
	target_is_directory = false;
	notices = {0:'移动成功！', 1:'移动失败！', 2:'移动失败！请确认mysql和es中的记录是否已修改！', 3:'移动失败！请确认es中的记录是否已修改！'};

	$.ajax({
		type: "POST",
		url: base_domain+"/spartacus-resource/cos/batchMove",
		dataType: "json",
		async: true,
		data: {
			"keysStr": keysStr,
			"destDirPath": destDirPath
		},
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function (result) {
			if(result.code == 0) {
				parent.layer.msg('正在移动，请稍后...', {
					icon: 1,
					time:1000
				});

			} else {
				parent.layer.msg(result.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}

function batchSetObjectAcl(keysStr, aclFlag) {
	target_is_directory = keysStr.endsWith('/') ? true : false;
	notices = {0:'设置成功！', 1:'设置失败！', 2:'设置失败！同步MYSQL及ES端权限失败！', 3:'设置失败！同步ES端权限失败！'};

	$.ajax({
		type: "POST",
		url: base_domain+"/spartacus-resource/cos/batchSetObjectAcl",
		dataType: "json",
		async: true,
		data : {
			"keysStr" : keysStr,
			"aclFlag" : aclFlag
		},
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function(result) {
			if(result.code == 0) {
				parent.layer.msg('正在设置，请稍后...', {
					icon: 1,
					time:1000
				});

			} else {
				parent.layer.msg(result.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}

function _batchSetObjectAcl(aclFlag) {
	var keysStr = "";

	// 获取所有已选中
	var selElements = document.getElementsByClassName('select');
	$(selElements).each(function () {
		if ($(this).css("display") == "block") {
			keysStr = keysStr + "," + $(this).attr("key");
		}
	});

	if (keysStr == null || keysStr == "") {
		parent.layer.msg('请先选择要设置的文件！', {
			icon: 2,
			time: 1000
		});
		return;
	}
	keysStr = keysStr.substring(1);
	batchSetObjectAcl(keysStr, aclFlag);
}

function setObjectAcl_1() {
	var key = $(global_object).attr('key');
    batchSetObjectAcl(key, 1);
}

function setObjectAcl_2() {
	var key = $(global_object).attr('key');
	batchSetObjectAcl(key, 2);
}

var menuItems = [
	{
		type: "item",
		icon: "eye",
		text: "点击预览",
		key: "preview",
		action: preview
	},
	{
		type: "item",
		icon: "copy",
		text: "复制外链",
		key: "copyOuterLink",
		action: copyOuterLink
	},
	{
		type: "item",
		icon: "download",
		text: "下载文件",
		key: "download",
		action: download
	},
	{
		type: "item",
		icon: "hand-stop-o ",
		text: "设为 公有读",
		key: "setObjectAcl_2",
		action: setObjectAcl_2
	},
	{
		type: "item",
		icon: "hand-grab-o ",
		text: "设为 私有读",
		key: "setObjectAcl_1",
		action: setObjectAcl_1
	},
	{
		type: "item",
		icon: "pencil",
		text: "重命名",
		key: "rename",
		action: rename
	},
	{
		type: "item",
		icon: "truck",
		text: "移到回收站",
		key: "recycle",
		action: recycle
	}
];

	var _menuItems = [
		{
			type: "item",
			icon: "eye",
			text: "点击预览",
			key: "preview",
			action: preview
		},
		{
			type: "item",
			icon: "copy",
			text: "复制外链",
			key: "copyOuterLink",
			action: copyOuterLink
		},
		{
			type: "item",
			icon: "download",
			text: "下载文件",
			key: "download",
			action: download
		},
		{
			type: "item",
			icon: "hand-stop-o ",
			text: "设为 公有读",
			key: "setObjectAcl_2",
			action: setObjectAcl_2
		},
		{
			type: "item",
			icon: "hand-grab-o ",
			text: "设为 私有读",
			key: "setObjectAcl_1",
			action: setObjectAcl_1
		},
		{
			type: "item",
			icon: "pencil",
			text: "重命名",
			key: "rename",
			action: rename
		},
		{
			type: "item",
			icon: "trash-o",
			text: "删除文件",
			key: "_delete",
			action: _delete
		}
	];

function loadTags() {
	$.ajax({
		type: "POST",
		url: base_domain+"/spartacus-resource/cos/listTags",
		dataType: "json",
		async: true,
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function (res) {
			if (res.code == 0) {
				// console.log(res);
				var data = res.data;
				$("#tag_list").children().remove();

				if(data.length > 0) {
					for (var i = 0; i < data.length; i++) {
						$("#tag_list").append("<li><a id='tag_" + i + "' href='javascript:void(0);'>" + data[i].text + "</a></li>");
						$("#tag_" + i).attr("onclick", "getPage(" + JSON.stringify(global_dir_path) + ",1," + global_pageSize + "," + JSON.stringify(data[i].text) + ")");
					}
				} else {
					$("#tag_list").append("<li><a href='javascript:void(0);'>暂无</a></li>");
				}

			} else {
				parent.layer.msg(res.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}

function createImage(url, key) {
	var img = new Image();
	img.alt='image';
	img.classList.add('img-responsive');
	img.src = url;
	img.onerror = function () {
		$.ajax({
			type: "POST",
			url: base_domain+"/spartacus-resource/cos/download",
			dataType: "json",
			async: true,
			data: {
				"key": key
			},
			headers: {
				"clientId":"spartacus-friday",
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success: function (res) {
				if (res.code == 0) {
					var base64 = res.data.base64;
					var contentType = res.data.contentType;
					img.src = "data:"+contentType+";base64," + base64;
				} else {
					parent.layer.msg(res.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});
	}
	return img;
}

function getPage(_path, _currentPage, _pageSize, _tag) {
	if(global_is_search) {
		submitSearch(global_cos_type, global_root_dir_path, global_currentPage, global_pageSize);
		return;
	}

	var _url = base_domain+"/spartacus-resource/cos/listObjects";

	var _isPreLoad = $('#loading_switch').get(0).checked;
	var _isRecursive = $('#recursive_switch').get(0).checked;

	$.ajax({
		type: "POST",
		url: _url,
		dataType: "json",
		async: true,
		data : {
			"isRecursive" : _isRecursive,
			"dirPath" : _path,
			"currentPage" : _currentPage,
			"pageSize" : _pageSize,
			"tag" : _tag
		},
		headers: {
			"clientId":"spartacus-friday",
			"Authorization":"bearer " + jwt.access_token//自定义请求头
		},
		success: function(result) {
			if(result.code == 0) {
				// console.log(result);
				$("#file_container_id").children().remove();

				var records = result.data.records;
				for(var i = 0; i < records.length; i++) {
					var aclFlag = records[i]['aclFlag'];
					var url = records[i]['url'];
					var key = records[i]['key'];
					var rootPath = records[i]['rootPath'];

					/*var fileName = url.substring(url.lastIndexOf('/')+1);
					if(fileName.lastIndexOf('-') != -1) {
						fileName = fileName.substring(fileName.lastIndexOf('-')+1);
					}*/
					var fileName = records[i]['fileName'];
					var putTime = millisecondsToLocalDate(records[i]['lastModified']);

					if(!url.endsWith('.html')) {
						if(aclFlag == 1) {
							$("#file_container_id").append("<div class='file-box leftClick rightClick' style='position: relative;height: 180px' onmousedown='setGlobalObject(this)' aclFlag='"+aclFlag+"' fileName='"+fileName+"' rootPath='"+rootPath+"' key='"+key+"' url='"+url+"'> <div id='file_"+i+"' class='file'>  <div class='file-name' align='center' style='word-break:break-all;text-overflow:ellipsis;overflow:hidden;white-space:normal;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;'> "+fileName+"<br/><small style='align-content: center;'>"+putTime+"</small> </div> </div> <span style='position:absolute; right:0; top:1%; margin-right: 20px;'> <img style='position: relative; top: 0; right: 0; border: 0;' src='img/ribbon_private.png'> </span><span class='select' key='"+key+"' style='position:absolute; right:0; top:1%; margin-right: 20px; display: none;'url='"+url+"'><img style='position: relative; bottom: 10px; right: 0; border: 0;'src='img/select.png'></span> </div>");
							if(_isPreLoad == true && checkImage(fileName)) {
								var icondiv = "<div id='icon_"+i+"' class='image' align='center' style='display:flex;justify-content:center;align-items:center;'></div>";
								$("#file_"+i).prepend(icondiv);
								var img = createImage(url, key);
								$("#icon_"+i).append(img);

							} else {
								var ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
								var icondiv = "<div id='icon_"+i+"' class='icon' align='center'><i class='fa fa-"+global_extensions[ext]+"'></i></div>";
								$("#file_"+i).prepend(icondiv);
							}
						} else {
							$("#file_container_id").append("<div class='file-box leftClick rightClick' style='position: relative;height: 180px' onmousedown='setGlobalObject(this)' aclFlag='"+aclFlag+"' fileName='"+fileName+"' rootPath='"+rootPath+"' key='"+key+"' url='"+url+"'> <div id='file_"+i+"' class='file'>  <div class='file-name' align='center' style='word-break:break-all;text-overflow:ellipsis;overflow:hidden;white-space:normal;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;'> "+fileName+"<br/><small style='align-content: center;'>"+putTime+"</small> </div> </div> <span style='position:absolute; right:0; top:1%; margin-right: 20px;'> <img style='position: relative; top: 0; right: 0; border: 0;' src='img/ribbon_public.png'> </span><span class='select' key='"+key+"' style='position:absolute; right:0; top:1%; margin-right: 20px; display: none;'url='"+url+"'><img style='position: relative; bottom: 10px; right: 0; border: 0;'src='img/select.png'></span> </div>");
							if(_isPreLoad == true && checkImage(fileName)) {
								var icondiv = "<div id='icon_"+i+"' class='image' align='center' style='display:flex;justify-content:center;align-items:center;'></div>";
								$("#file_"+i).prepend(icondiv);
								var img = createImage(url, key);
								$("#icon_"+i).append(img);

							} else {
								var ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
								var icondiv = "<div id='icon_"+i+"' class='icon' align='center'><i class='fa fa-"+global_extensions[ext]+"'></i></div>";
								$("#file_"+i).prepend(icondiv);
							}
						}
					}
				}

				//左键选中
				$(".leftClick").click(function() {
					var sel = $(this).children('.select'); //获取直接子元素
					if($(sel).css('display') == 'none') {
						$(sel).css('display','block');
					} else {
						$(sel).css('display','none');
					}
				});

				//右键菜单
				$('.file-box').each(function () {
					animationHover(this, 'pulse');
				});

				if(global_root_dir_path != 'recycle/') {
					$(".rightClick").contextMenu({
						items: menuItems
					});
				} else {
					$(".rightClick").contextMenu({
						items: _menuItems
					});
				}

				if(isPaginatorExist1 == false) {
					//构造分页按钮组
					$('#page_element_id2').children().remove();
					var _total = parseInt(result.data.total);
					var page_element = BootstrapPagination($("#page_element_id1"), {
						layoutScheme: "pagesizelist,firstpage,prevgrouppage,prevpage,pagenumber,nextpage,nextgrouppage,lastpage,pageinput,righttext",
						//记录总数。
						total: _total,
						//分页尺寸。指示每页最多显示的记录数量。
						pageSize: _pageSize,
						//当前页索引编号。从0开始的整数。
						pageIndex: _currentPage-1,
						//指示分页导航栏中最多显示的页索引数量。
						pageGroupSize: 5,
						//位于导航条左侧的输出信息格式化字符串
						//leftFormateString: "本页{count}条记录/共{total}条记录",
						//位于导航条右侧的输出信息格式化字符串
						rightFormateString: "共{totalPages}页",
						//页码文本格式化字符串。
						pageNumberFormateString: "{pageNumber}",
						//分页尺寸输出格式化字符串
						pageSizeListFormateString: "{pageSize}条/页",
						//上一页导航按钮文本。
						prevPageText: "上一页",
						//下一页导航按钮文本。
						nextPageText: "下一页",
						//上一组分页导航按钮文本。
						prevGroupPageText: "上一组",
						//下一组分页导航按钮文本。
						nextGroupPageText: "下一组",
						//首页导航按钮文本。
						firstPageText: "首页",
						//尾页导航按钮文本。
						lastPageText: "尾页",
						//设置页码输入框中显示的提示文本。
						pageInputPlaceholder: "go",
						//接受用户输入内容的延迟时间。单位：毫秒
						pageInputTimeout: 1000,
						//分页尺寸列表。
						pageSizeList: [15, 20, 30, 45, 50],
						//当分页更改后引发此事件。
						pageChanged: function (pageIndex, pageSize) {
							getPage(_path, pageIndex + 1, pageSize, _tag);
						},
					});
					isPaginatorExist1 = true;
				}

			} else {
				parent.layer.msg(result.message, {
					icon: 2,
					time:1000
				});
			}
		}
	});
}


var isPaginatorExist2 = false;
function submitSearch(_cosType, _rootDirPath, _currentPage, _pageSize) {
	global_is_search = true;
	var _isPreLoad = $('#loading_switch').get(0).checked;

	global_currentPage = _currentPage;
	global_pageSize = _pageSize;

	var searchContent = $("#search_input_id").val();
	if(!$.trim(searchContent)){ // "",null,undefined
		parent.layer.msg('搜索内容不能为空！', {
			icon: 2,
			time:1000
		});
		$("#search_input_id").val("");
		$("#search_input_id").focus();
	} else {
		$.ajax({
			type : "POST",
			url : base_domain+"/spartacus-resource/cos/search",
			async : true,
			data : { //使用Json格式进行透传
				"searchText" : searchContent,
				"cosType" : _cosType,
				"rootDirPath" : _rootDirPath,
				"currentPage" : _currentPage,
				"pageSize" : _pageSize
			},
			dataType:"json",
			headers: {
				"clientId":"spartacus-friday",
				"Authorization":"bearer " + jwt.access_token//自定义请求头
			},
			success : function(result) {
				console.log(result);
				if (result.code==0) {
					$("#file_container_id").children().remove();
					var records = result.data.records;
					for(var i = 0; i < records.length; i++) {
						var aclFlag = records[i]['aclFlag'];
						var url = records[i]['url'];
						var key = records[i]['key'];
						var rootPath = records[i]['rootPath'];
						var fileName = records[i]['fileName'];
						var _fileName = fileName.replace(/<[^>]+>/g,""); //去除html标签
						var putTime = millisecondsToLocalDate(records[i]['lastModified']);

						if(!url.endsWith('.html')) {
							if(aclFlag == 1) {
								$("#file_container_id").append("<div class='file-box leftClick rightClick' style='position: relative;height: 180px' onmousedown='setGlobalObject(this)' aclFlag='"+aclFlag+"' fileName='"+_fileName+"' rootPath='"+rootPath+"' key='"+key+"' url='"+url+"'> <div id='file_"+i+"' class='file'>  <div class='file-name' align='center' style='word-break:break-all;text-overflow:ellipsis;overflow:hidden;white-space:normal;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;'> "+fileName+"<br/><small style='align-content: center;'>"+putTime+"</small> </div> </div> <span style='position:absolute; right:0; top:1%; margin-right: 20px;'> <img style='position: relative; top: 0; right: 0; border: 0;' src='img/ribbon_private.png'> </span><span class='select' key='"+key+"' style='position:absolute; right:0; top:1%; margin-right: 20px; display: none;'url='"+url+"'><img style='position: relative; bottom: 10px; right: 0; border: 0;'src='img/select.png'></span> </div>");
								if(_isPreLoad == true && checkImage(_fileName)) {
									var icondiv = "<div id='icon_"+i+"' class='image' align='center' style='display:flex;justify-content:center;align-items:center;'></div>";
									$("#file_"+i).prepend(icondiv);
									var img = createImage(url, key);
									$("#icon_"+i).append(img);

								} else {
									var ext = _fileName.substring(_fileName.lastIndexOf('.')).toLowerCase();
									var icondiv = "<div id='icon_"+i+"' class='icon' align='center'><i class='fa fa-"+global_extensions[ext]+"'></i></div>";
									$("#file_"+i).prepend(icondiv);
								}
							} else {
								$("#file_container_id").append("<div class='file-box leftClick rightClick' style='position: relative;height: 180px' onmousedown='setGlobalObject(this)' aclFlag='"+aclFlag+"' fileName='"+_fileName+"' rootPath='"+rootPath+"' key='"+key+"' url='"+url+"'> <div id='file_"+i+"' class='file'>  <div class='file-name' align='center' style='word-break:break-all;text-overflow:ellipsis;overflow:hidden;white-space:normal;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;'> "+fileName+"<br/><small style='align-content: center;'>"+putTime+"</small> </div> </div> <span style='position:absolute; right:0; top:1%; margin-right: 20px;'> <img style='position: relative; top: 0; right: 0; border: 0;' src='img/ribbon_public.png'> </span><span class='select' key='"+key+"' style='position:absolute; right:0; top:1%; margin-right: 20px; display: none;'url='"+url+"'><img style='position: relative; bottom: 10px; right: 0; border: 0;'src='img/select.png'></span> </div>");
								if(_isPreLoad == true && checkImage(_fileName)) {
									var icondiv = "<div id='icon_"+i+"' class='image' align='center' style='display:flex;justify-content:center;align-items:center;'></div>";
									$("#file_"+i).prepend(icondiv);
									var img = createImage(url, key);
									$("#icon_"+i).append(img);

								} else {
									var ext = _fileName.substring(_fileName.lastIndexOf('.')).toLowerCase();
									var icondiv = "<div id='icon_"+i+"' class='icon' align='center'><i class='fa fa-"+global_extensions[ext]+"'></i></div>";
									$("#file_"+i).prepend(icondiv);
								}
							}
						}
					}

					//左键选中
					$(".leftClick").click(function() {
						var sel = $(this).children('.select'); //获取直接子元素
						if($(sel).css('display') == 'none') {
							$(sel).css('display','block');
						} else {
							$(sel).css('display','none');
						}
					});

					//右键菜单
					$('.file-box').each(function () {
						animationHover(this, 'pulse');
					});
					$(".rightClick").contextMenu({
						items: menuItems
					});

					if(isPaginatorExist2 == false) {
						//构造分页按钮组
						$('#page_element_id1').children().remove();
						var total = parseInt(result.data.total);
						var page_element = BootstrapPagination($("#page_element_id2"), {
							layoutScheme: "pagesizelist,firstpage,prevgrouppage,prevpage,pagenumber,nextpage,nextgrouppage,lastpage,pageinput,righttext",
							//记录总数。
							total: total,
							//分页尺寸。指示每页最多显示的记录数量。
							pageSize: _pageSize,
							//当前页索引编号。从0开始的整数。
							pageIndex: _currentPage-1,
							//指示分页导航栏中最多显示的页索引数量。
							pageGroupSize: 10,
							//位于导航条左侧的输出信息格式化字符串
							//leftFormateString: "本页{count}条记录/共{total}条记录",
							//位于导航条右侧的输出信息格式化字符串
							rightFormateString: "共{totalPages}页",
							//页码文本格式化字符串。
							pageNumberFormateString: "{pageNumber}",
							//分页尺寸输出格式化字符串
							pageSizeListFormateString: "{pageSize}条/页",
							//上一页导航按钮文本。
							prevPageText: "上一页",
							//下一页导航按钮文本。
							nextPageText: "下一页",
							//上一组分页导航按钮文本。
							prevGroupPageText: "上一组",
							//下一组分页导航按钮文本。
							nextGroupPageText: "下一组",
							//首页导航按钮文本。
							firstPageText: "首页",
							//尾页导航按钮文本。
							lastPageText: "尾页",
							//设置页码输入框中显示的提示文本。
							pageInputPlaceholder: "go",
							//接受用户输入内容的延迟时间。单位：毫秒
							pageInputTimeout: 1000,
							//分页尺寸列表。
							pageSizeList: [15, 20, 30, 45, 50],
							//当分页更改后引发此事件。
							pageChanged: function (pageIndex, pageSize) { //pageIndex从0开始
								submitSearch(_cosType, _rootDirPath, pageIndex+1, pageSize);
							},
						});
						isPaginatorExist2 = true;
					}
				} else {
					parent.layer.msg(result.message, {
						icon: 2,
						time:1000
					});
				}
			}
		});
	}
}



// 2、目录树
$(document).ready(function () {
    $('#jstree').jstree({ //生成jstree
        'core': {
            'check_callback': true,
            'data' : function (obj, callback) {
                $.ajax({
                    type: "POST",
                    url: base_domain+"/spartacus-resource/cos/getDirectoryTree",
                    dataType: "json",
                    async: true,
                    data : {
		            	"rootDirPath" : global_root_dir_path,
		            },
					headers: {
						"clientId":"spartacus-friday",
						"Authorization":"bearer " + jwt.access_token//自定义请求头
					},
                    success: function(result) {
                    	if(result.code == 0) {
                    		// console.log(result);
                        	var jsonArray = [];
                            var nodes= result.data;
                            for(var i=0 ; i<nodes.length; i++) {
                                var _json = {
                                    "id" : nodes[i].id,
                                    "parent" : nodes[i].parentId==null ? "#" : nodes[i].parentId,
                                    "text" : nodes[i].fileName,
                                    "state" : {"opened" : true}
                                }
                                if(nodes[i].aclFlag == 1) {
                                	_json.icon = "fa fa-lock";
                                } else if(nodes[i].aclFlag == 2) {
                                	_json.icon = "fa fa-unlock-alt";
                                } else if(nodes[i].aclFlag == 3) {
                                	_json.icon = "fa fa-unlock";
                                } 
                                jsonArray.push(_json);
	                        }
                            callback.call(this, jsonArray);

                        } else {
							parent.layer.msg(result.message, {
								icon: 2,
								time:1000
							});
                        }
                    }
                });
            }
        },
        'plugins': ['types', 'contextmenu'],
        'types': {
            'default': {
                'icon': 'fa fa-folder'
            }
        },
        "contextmenu":{ //自定义右键菜单项
		  "items":{
		    	"Create":{
                    "label":"新建目录",
                    "action":function(data){
                        var node = $('#jstree').jstree('get_node',data.reference[0])
//                          var pid = node.parent;
//                          console.log(pid, node.text);
						var names = $('#jstree').jstree('get_path', node, '/', false)
//		    				console.log(names.replace(/\s*/g,""));
						var path = names.replace(/\s*/g,"");
	    				
	    				//
	    				var instance = $.jstree.reference(data.reference);
						obj = instance.get_node(data.reference);
						var new_node_id = instance.create_node(obj, {}, "last", function (new_node) {
							new_node.text = "新建目录";
							instance.edit(new_node, "新建目录", function (_node,_status,_cancel) {
								if(_status) {
									$.ajax({
										type: "POST",
										url: base_domain+"/spartacus-resource/cos/createDirectory",
										dataType: "json",
										async: true,
										data : {
											"parentDirPath" : path + "/",
											"parentId" : node.id,
											"newDirName" : _node.text
										},
										headers: {
											"clientId":"spartacus-friday",
											"Authorization":"bearer " + jwt.access_token//自定义请求头
										},
										success: function(result) {
											if(result.code == 0) {
												parent.layer.msg('新建成功！', {
													icon: 1,
													time:1000
												});
												$('#jstree').jstree('refresh');
											} else {
												parent.layer.msg(result.message, {
													icon: 2,
													time:1000
												});
												instance.delete_node(new_node);
											}
										}
									});
								} else {
									parent.layer.msg('新建失败！', {
										icon: 2,
										time:1000
									});
									instance.delete_node(new_node);
								}
							});
						});
	    				//
                    }
                },
		        "Delete":{
                    "label":"删除目录",
                    "action":function(data) {
                        var node = $('#jstree').jstree('get_node',data.reference[0])
                    	var names = $('#jstree').jstree('get_path', node, '/', false)
                    	var path = names.replace(/\s*/g,"");
//                      	console.log(path);
                    	//
                    	parent.layer.confirm('确定删除['+path+'/]吗？', {
                    		icon: 0,
						  	btn: ['确定','取消'] //按钮
						}, function() {
                    		target_is_directory = true;
							notices = {0:'删除成功！', 1:'删除失败！'};

							$.ajax({
								type: "POST",
								url: base_domain+"/spartacus-resource/cos/deleteDirectory",
								dataType: "json",
								async: true,
								data : {
									"targetDirPath" : path + "/"
								},
								headers: {
									"clientId":"spartacus-friday",
									"Authorization":"bearer " + jwt.access_token//自定义请求头
								},
								success: function(result) {
									if(result.code == 0) {
										parent.layer.msg('正在删除，请稍后...', {
											icon: 1,
											time:1000
										});
										/*var instance = $.jstree.reference(data.reference);
										obj = instance.get_node(data.reference);
										var isSuccess = instance.delete_node(obj);*/
										// $('#jstree').jstree('refresh');
									} else {
										parent.layer.msg(result.message, {
											icon: 2,
											time:1000
										});
									}
								}
							});
						});
                    	//
                    }
                },
                "Access control":{
            		"label":"权限控制",
            		"submenu" : {
            			"PublicReadPrivateWrite" : {
            				"label":"设为 公有读",
	                        "action":function(data) {
	                            var node = $('#jstree').jstree('get_node',data.reference[0])
	                            var names = $('#jstree').jstree('get_path', node, '/', false)
//				    				console.log(names.replace(/\s*/g,""));
								var path = names.replace(/\s*/g,"");
								
								//
								batchSetObjectAcl(path + "/", 2);
								//
	                        }
            			},
            			"PrivateReadPrivateWrite" : {
            				"label":"设为 私有读",
	                        "action":function(data) {
	                            var node = $('#jstree').jstree('get_node',data.reference[0])
	                            var names = $('#jstree').jstree('get_path', node, '/', false)
//				    				console.log(names.replace(/\s*/g,""));
								var path = names.replace(/\s*/g,"");
								
								//
								batchSetObjectAcl(path + "/", 1);
								//
	                        }
            			}
                   }
                }
		  	}
		}
    }).bind("activate_node.jstree", function (obj, data) { //绑定单击事件
    	if('click'==data.event.type) { //判断是否是左键
		    var ids = data.instance.get_path(data.node,'/',true)
		    var names = data.instance.get_path(data.node, '/', false)
//		    console.log(ids.replace(/\s*/g,""));
//			    console.log(names.replace(/\s*/g,""));
			var path = names.replace(/\s*/g,"");
			global_dir_path = path+"/";

			console.log("global_dir_path :" + global_dir_path);

		    //
			global_is_search = false;
			getPage(global_dir_path, global_currentPage, global_pageSize, null);
			loadTags();
			//
	    }
	}).on('loaded.jstree', function(e, data) { //目录树加载完毕后默认选中根节点
    	var obj = data.instance.get_node(e.target.firstChild.firstChild.lastChild);
    	data.instance.select_node(obj);
    	
    	var names = data.instance.get_path(obj, '/', false)
		var path = names.replace(/\s*/g,"");
		global_dir_path = path+"/";
//		console.log(path);
    	//
		global_is_search = false;
		getPage(global_dir_path, 1, 15, null);
		loadTags();
		//
   });

	//刷新目录树的按钮事件
	$('#refresh_id').click(function () {
		btn = $(this);
		btn.children().addClass('fa-spin');
		//
		$('#jstree').jstree('refresh');
		//
		window.setTimeout(function () {
			btn.children().removeClass('fa-spin');
		}, 1000);
	});


	//下拉菜单中的目录树
	$('#menu_tree_id').jstree({ //生成jstree
		'core': {
			'check_callback': true,
			'data' : function (obj, callback) {
				$.ajax({
					type: "POST",
					url: base_domain+"/spartacus-resource/cos/getDirectoryTree",
					dataType: "json",
					async: true,
					/*data : {
						"rootDirPath" : "image/",
					},*/
					headers: {
						"clientId":"spartacus-friday",
						"Authorization":"bearer " + jwt.access_token//自定义请求头
					},
					success: function(result) {
						console.log(result);
						if(result.code == 0) {
							var jsonArray = [];
							var nodes= result.data;
							for(var i=0 ; i<nodes.length; i++) {
								var _json = {
									"id" : nodes[i].id,
									"parent" : nodes[i].parentId==null ? "#" : nodes[i].parentId,
									"text" : nodes[i].fileName,
									"state" : {"opened" : true}
								}
								if(nodes[i].aclFlag == 1) {
									_json.icon = "fa fa-lock";
								} else if(nodes[i].aclFlag == 2) {
									_json.icon = "fa fa-unlock-alt";
								} else if(nodes[i].aclFlag == 3) {
									_json.icon = "fa fa-unlock";
								}
								jsonArray.push(_json);
							}
							callback.call(this, jsonArray);

						} else {
							parent.layer.msg(result.message, {
								icon: 2,
								time:1000
							});
						}
					}
				});
			}
		},
		'plugins': ['types'],
		'types': {
			'default': {
				'icon': 'fa fa-folder'
			}
		},
	}).bind("activate_node.jstree", function (obj, data) { //绑定单击事件
		if('click'==data.event.type) { //判断是否是左键
			var ids = data.instance.get_path(data.node,'/',true)
			var names = data.instance.get_path(data.node, '/', false)
			var path = names.replace(/\s*/g,"") + "/";

			//
			var keysStr = "";
			var selElements = document.getElementsByClassName('select');
			$(selElements).each(function () {
				if ($(this).css("display") == "block") {
					keysStr = keysStr + "," + $(this).attr("key");
				}
			});
			if (keysStr == null || keysStr == "") {
				parent.layer.msg('请先选择要移动的文件！', {
					icon: 2,
					time: 1000
				});
				return;
			}
			keysStr = keysStr.substring(1);
			batch_move(keysStr, path)
			//
		}
	});

});


function webUploader() {
	layer.confirm('当前选择的路径是\''+global_dir_path+'\'，确定吗？', {icon: 3, title:'重要'}, function(index) {
		is_upload_success = false;
  		layer.open({
		  type: 2,
		  title: '上传文件',
		  shadeClose: true,
		  shade: 0.5,
		  area: ['50%', '570px'],
		  content: 'web_uploader.html',
		  end: function() { //关闭上传窗口的回调
		  	if(is_upload_success) {
		  		//
				isPaginatorExist1 = false
				getPage(global_dir_path, global_currentPage, global_pageSize, null);
				//
		  	}
		  }
		});
	  	layer.close(index);
	});
}


</script>

</body>

</html>
